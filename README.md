# zo-backend

## Описание.

На этой странице представлен source-code веб-сервиса, .env файл, содержащий API-ключ от Яндекс.Диска и порт сервера, и папка \_\_dev__certificates__, хранящая необходимые файлы для реализации функционала создания сертификатов.

Базовый URL оканчивается на `/api/v1`. Это значит, что при включении веб-сервиса локально обращение к API осуществляется через базовый URL `http://localhost:8080/api/v1`.

Все данные хранятся в сервисах Фейскаст (ФК) Даша-Мейл (ДМ). Они используются в качестве баз данных, а доступ к данным осуществляется через [API ДМ](https://dashamail.ru/api/) и [API ФК](https://facecast.net/api/v1).

Для использования GET-запросов параметры необходимо передавать в строке, а для использования POST-запросов - в теле запроса в JSON-формате. Для использования WEBSOCKET-запросов необходимо передавать на endpoint `/websocket` сообщения в виде:

```
{
    'apiMethod': 'API-METHOD-NAME',
    'data': JSON-DATA,
}
```

При любой ошибке во время выполнения запроса возвращается структура вида:

```
{
    "message": "ERROR-TEXT"
}

"ERROR-TEXT" - текстовое описание ошибки
```

Для просмотра доступных API-методов и их функционала воспользуйтесь [оглавлением](#Оглавление) ниже. Если явно не прописано, то информация ищется в книге ДМ "Регистрация на сайте ЗО". Для уточнения значений названий столбцов в книгах ДМ или параметров в ФК обращаться к руководителю IT-отдела.

## Оглавление.

1. [GET /`{unknown-resource}`](#get-unknown-resource)
2. [GET /getUserLK](#get-getuserlk)
3. [GET /getUserPoints](#get-getuserpoints)
4. [GET /getWebinarReportInfo](#get-getwebinarreportinfo)
5. [GET /getCampaignsReportInfo](#get-getcampaignsreportinfo)
6. [POST /`{unknown-resource}`](#post-unknown-resource)
7. [POST /facecastLogin](#post-facecastlogin)
8. [POST /getDashaMailData](#post-getdashamaildata)
9. [POST /createWebinarReport](#post-createwebinarreport)
10. [POST /createCampaignsReport](#post-createcampaignsreport)
11. [POST /sendDataToDashaMail](#post-senddatatodashamail)
12. [WEBSOCKET /websocket](#websocket-websocket)
___

## __GET__ /`{unknown-resource}`

При обращении к несуществующему ресурсу GET-запрос вернёт JSON-ответ:

```
{
    "message": "unknown GET API endpoint /{unknown-resource}"
}

{unknown-resource} - несуществующий ресурс
```

[⬆ к оглавлению](#Оглавление)
___

## __GET__ /getUserLK

Параметры запроса:

| НАЗВАНИЕ |  ТИП   |           ОПИСАНИЕ           |
|:--------:|:------:|:----------------------------:|
|  email   | string | Почта пользользователя в ДМ. |

Параметры ответа:

```
{
    "message": "",             // возможная ошибка, которая могла возникнуть во время получения ответа (пустая строка по умолчанию)
    "status": 0,               // код статуса подписчика, возможные варианты: 1-5, -1 (для неизвестного ранее statusExplain)
    "statusExplain": "",       // статус подписчика, возможные варианты: active, unsubscribed, bounced, inactive, unconfirmed
    "name": "",                // поле 'name' в книге 'Регистрация на сайте ЗО' ДМ
    "phone": "",               // поле 'phone' в книге 'Регистрация на сайте ЗО' ДМ
    "citizenship": "",         // поле 'ваше_гражданство' в книге 'Регистрация на сайте ЗО' ДМ
    "district": "",            // поле 'федеральный_округ' в книге 'Регистрация на сайте ЗО' ДМ
    "region": "",              // поле 'регион_для_россии' в книге 'Регистрация на сайте ЗО' ДМ
    "city": "",                // поле 'город_где_вы_ведете_врачебную_практику' в книге 'Регистрация на сайте ЗО' ДМ
    "specialization": "",      // поле 'медицинская_специализация' в книге 'Регистрация на сайте ЗО' ДМ
    "specializationExtra": "", // поле 'дополнительная_медицинская_специализация' в книге 'Регистрация на сайте ЗО' ДМ
    "position": "",            // поле 'ваша_должность' в книге 'Регистрация на сайте ЗО' ДМ
    "own": "",                 // поле 'свои' в книге 'Регистрация на сайте ЗО' ДМ
}
```

Ответ содержит указанные параметры, только если они не равны значениям по умолчанию. 

[⬆ к оглавлению](#Оглавление)
___

## __GET__ /getUserPoints

Параметры запроса:

| НАЗВАНИЕ |  ТИП   | ОПИСАНИЕ                                                                              |
|:--------:|:------:|:--------------------------------------------------------------------------------------|
|  email   | string | Почта пользользователя в ДМ.                                                          |
|   type   | string | Тип баллов, которые хотим получить.<br/>Сейчас доступно два значения: 'NMO' или 'ZO'. |

Параметры ответа:

```
{
    "yearPoints": 0,    // количество баллов за текущий год
    "quarterPoints": 0, // количество баллов за текущий квартал
    "userInfo": [],   // массив (если данных в массиве нет, то этот параметр опускается)
}
```

Элементы параметра userInfo имеют следующий вид:

```
{
    "event_date": "",         // поле 'event_date' в книгах ДМ
    "event_name": "",         // поле 'event_name' в книгах ДМ
    "nmo": "",                // поле 'код_нмо' в книгах ДМ
    "zet": "",                // поле 'зет' в книгах ДМ
    "certificate": "",        // поле 'ссылка_на_сертификат' в книгах ДМ
    "points_zo_view": "",     // поле 'бонусы_зо_за_просмотр' в книгах ДМ
    "points_zo_question": "", // поле 'бонусы_зо_за_вопрос' в книгах ДМ
    "points_zo_poll": "",     // поле 'бонусы_зо_за_опрос' в книгах ДМ
}
```

Элементы параметра userInfo содержат указанные параметры, только если они не равны значениям по умолчанию.

Для type = 'NMO' массив содержит элементы, если среди всех книг ДМ для email нашлась хоть одна запись, для которой есть непустой код НМО.

Для type = 'ZO' массив содержит элементы, если среди всех книг ДМ для email нашлась хоть одна запись, для которой есть непустые баллы ЗО и дата мероприятия принадлежит текущему кварталу.

[⬆ к оглавлению](#Оглавление)
___

## __GET__ /getWebinarReportInfo

Параметры запроса:

| НАЗВАНИЕ |  ТИП   | ОПИСАНИЕ             |
|:--------:|:------:|:---------------------|
| eventID  | string | Код трансляции в ФК. |

Параметры ответа:

```
{
    "reportName": "", // название отчета
    "eventInfo": {},  // информация о мероприятии
    "usersInfo": {},  // структура ключ-значение, где ключ - почта пользователя в ДМ, а значение - информация о пользователе для построения отчета
}
```

Ответ всегда содержит, как минимум, параметр 'reportName'. Остальные параметры присутствуют, только если они не равны значениям по умолчанию.

Элементы параметра eventInfo имеют следующий вид:

```
{
    "name": "",             // название трансляции в ФК
    "description": "",      // описание трансляции в ФК
    "date_plan_start": "",  // запланированное время начала трансляции в ФК
    "date_real_start": "",  // реальное время начала трансляции в ФК
    "date_real_end": "",    // реальное время окончания трансляции в ФК
    "duration_total": 0,    // суммарная длительность трансляции в ФК в минутах
    "viewers_max": 0,       // максимальное кол-во зрителей одновременно на трансляции в ФК
    "time_viewers_max": "", // время для 'viewers_max' 
    "viewers_total" : 0,    // суммарное кол-во зрителей трансляции в ФК
    "report_time" : "",     // время построения отчета
}
```

Элементы параметра eventInfo содержат указанные параметры, только если они не равны значениям по умолчанию.

Элементы параметра usersInfo имеют следующий вид:

```
{
    "message": "",          // возможная ошибка, которая могла возникнуть во время получения для конкретного email (пустая строка по умолчанию) 
    "fio": "",
    "email": "",
    "key": "",
    "minutesViewedOnline": 0, 
    "firstMinuteOnline": 0, 
    "lastMinuteOnline": 0,
    "minutesOnline": null,  // []int 
    "minutesViewedOffline": 0,
    "firstMinuteOffline": 0,
    "lastMinuteOffline": 0,
    "minutesOffline": null, // []int
    "confirmedWindows": 0,
    "allWindows": 0,
    "wayToAdd": "",
    "eventID": "",
    "citizenship": "",
    "district": "",
    "region": "",
    "city": "",
    "specialization": "",
    "specializationExtra": "",
    "position": "",
    "own": "",
    "viewRegime": "",
    "pointsZOView": 0,
}
```

Элементы параметра usersInfo всегда содержат, как минимум, параметры 'message', 'firstMinuteOnline', 'lastMinuteOnline', 'firstMinuteOffline', 'lastMinuteOffline', 'pointsZOView'. Остальные параметры присутствуют, только если они не равны значениям по умолчанию.

[⬆ к оглавлению](#Оглавление)
___

## __GET__ /getCampaignsReportInfo

Либо оба параметра запроса - непустые строки формата '2006-01-02', либо оба - пустые строки. В последнем случае end_date - текущая дата, а start_date - дата за 30 дней до текущей даты.

Параметры запроса:

|  НАЗВАНИЕ  |  ТИП   | ОПИСАНИЕ                                                 |
|:----------:|:------:|:---------------------------------------------------------|
| start_date | string | Начальная дата в фильтре для рассылок, входящих в отчет. |
|  end_date  | string | Конечная дата в фильтре для рассылок, входящих в отчет.  |

Параметры ответа:

```
[
    {
        "date": "",
        "name": "",
        "tagUTM": ,
        "sourceUTM": ,
        "mediumUTM": ,
        "contentUTM": ,
        "termUTM": ,
        "sent": 0,
        "clicked": 0,
        "opened": 0,
        "firstSent": "",
        "firstOpen": "",
        "lastOpen": "",
        "firstClick": "",
        "lastClick": "",
        "uniqueOpened": 0,
        "uniqueClicked": 0,
        "unsubscribed": 0,
        "spamComplained": 0,
        "spamBlocked": 0,
        "spamMarked": 0,
        "mailSystemBlocked": 0,
        "hard": 0,
        "soft": 0,         
    }

    ...
]
```

Элементы ответа массива всегда содержат, как минимум, параметры 'date', 'name'. Остальные параметры присутствуют, только если они не равны значениям по умолчанию.

[⬆ к оглавлению](#Оглавление)
___

## __POST__ /{`unknown-resource`}

При обращении к несуществующему ресурсу POST-запрос вернёт JSON-ответ:

```
{
    "message": "unknown POST API endpoint /{unknown-resource}"
}

{unknown-resource} - несуществующий ресурс
```

[⬆ к оглавлению](#Оглавление)
___

## __POST__ /facecastLogin

Параметры запроса:

| НАЗВАНИЕ |  ТИП   | ОПИСАНИЕ                                                                                                                                                                                                                               |
|:--------:|:------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| eventID  | string | Начальная дата в фильтре для рассылок, входящих в отчет.                                                                                                                                                                               |

Также в запрос необходимо включить параметры одного из вариантов:

Параметры первого варианта:

|    НАЗВАНИЕ     |  ТИП   | ОПИСАНИЕ                                               |
|:---------------:|:------:|:-------------------------------------------------------|
| personalPhrases | string | Строка с персональными фразами для трансляции eventID. |

Параметры второго варианта:

| НАЗВАНИЕ |  ТИП   | ОПИСАНИЕ                                                             |
|:--------:|:------:|:---------------------------------------------------------------------|
|  email   | string | Имя пользователя для автологина на трансляции eventID.               |
|   name   | string | Электронная почта пользователя для автологина на трансляции eventID. |

Параметры ответа:

```
{
    "key": "",
    "personalPhrases": "", // кастомные ответы модераторов для трансляции в ФК
}
```

Элементы ответа содержат указанные параметры, только если они не равны значениям по умолчанию.

[⬆ к оглавлению](#Оглавление)
___

## __POST__ /getDashaMailData

Параметры запроса:

| НАЗВАНИЕ |   ТИП    | ОПИСАНИЕ                                                                        |
|:--------:|:--------:|:--------------------------------------------------------------------------------|
|  bookID  |  string  | ID книги в ДМ.                                                                  |
|  emails  | []string | Почты пользователей, по которым необходимо получить информацию из книги bookID. |

Параметр ответа - структура ключ-значение, где ключ - почта пользователя, а значение - структура следующего вида:

```
{
    "message": "",             // возможная ошибка, которая могла возникнуть во время получения ответа (пустая строка по умолчанию)
    "status": 0,               // код статуса подписчика, возможные варианты: 1-5, -1 (для неизвестного ранее statusExplain)
    "statusExplain": "",       // статус подписчика, возможные варианты: active, unsubscribed, bounced, inactive, unconfirmed
    "name": "",                // поле 'name' в книгах ДМ
    "phone": "",               // поле 'phone' в книгах ДМ
    "citizenship": "",         // поле 'ваше_гражданство' в книгах ДМ
    "district": "",            // поле 'федеральный_округ' в книгах ДМ
    "region": "",              // поле 'регион_для_россии' в книгах ДМ
    "city": "",                // поле 'город_где_вы_ведете_врачебную_практику' в книгах ДМ
    "specialization": "",      // поле 'медицинская_специализация' в книгах ДМ
    "specializationExtra": "", // поле 'дополнительная_медицинская_специализация' в книгах ДМ
    "position": "",            // поле 'ваша_должность' в книгах ДМ
    "own": "",                 // поле 'свои' в книгах ДМ
    "event_date": "",          // поле 'event_date' в книгах ДМ
    "event_name": "",          // поле 'event_name' в книгах ДМ
    "nmo": "",                 // поле 'код_нмо' в книгах ДМ
    "zet": "",                 // поле 'зет' в книгах ДМ
    "certificate": "",         // поле 'ссылка_на_сертификат' в книгах ДМ
    "points_zo_view": "",      // поле 'бонусы_зо_за_просмотр' в книгах ДМ
    "points_zo_question": "",  // поле 'бонусы_зо_за_вопрос' в книгах ДМ
    "points_zo_poll": "",      // поле 'бонусы_зо_за_опрос' в книгах ДМ
}
```

Элементы структуры ответ всегда содержат, как минимум, параметр 'message'. Остальные параметры присутствуют, только если они не равны значениям по умолчанию.

[⬆ к оглавлению](#Оглавление)
___

## __POST__ /createWebinarReport

Параметры запроса:

|  НАЗВАНИЕ  |   ТИП    | ОПИСАНИЕ                                                                                                                                                                                                     |
|:----------:|:--------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| reportName |  string  | Название для построения отчета.                                                                                                                                                                              |
| reportData | []string | Строки, содержащие информацию для создания отчета по мероприятию. Формат можно посмотреть в [примере](https://docs.google.com/spreadsheets/d/15FFQRrl7_rIyrGloaQCP4BwCCGE_SQJV8Q-ad29ZBkw/edit?usp=sharing). |

Успешный запрос возвращает нулевой ответ.

[⬆ к оглавлению](#Оглавление)
___

## __POST__ /createCampaignsReport

Параметры запроса:

|  НАЗВАНИЕ  |   ТИП    | ОПИСАНИЕ                                                                                                                                                                                                     |
|:----------:|:--------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| reportName |  string  | Название для построения отчета.                                                                                                                                                                              |
| reportData | []string | Строки, содержащие информацию для создания отчета по мероприятию. Формат можно посмотреть в [примере](https://docs.google.com/spreadsheets/d/1UpfwYfyoEreUQAhSCoVP3kgk4mI4dMav8uSNr4TiAnI/edit?usp=sharing). |

Успешный запрос возвращает нулевой ответ.

[⬆ к оглавлению](#Оглавление)
___

## __POST__ /sendDataToDashaMail

Параметры запроса:

| НАЗВАНИЕ |           ТИП            | ОПИСАНИЕ                                                                                                                                    |
|:--------:|:------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------|
|  bookID  |          string          | ID книги в ДМ.                                                                                                                              |
|  infoDM  | map\[string\]interface{} | Структура ключ-значение, где ключ - обновляемое поле в книге bookID, а значение - величина нужного типа (зависит от настроек книги bookID). |

Успешный запрос возвращает нулевой ответ.

[⬆ к оглавлению](#Оглавление)
___

## __WEBSOCKET__ /websocket

Исторически необходимость в WEBSOCKET-запросах появилась для обхождения ограничения по времени для обычных HTTP-запросов при размещении веб-сервиса на [Heroku](https://www.heroku.com/). Бывает, что необходимо построить отчет для очень большого количества участников, а API ДМ не имел (по крайней мере на момент написания этого кода) метода для возврата информации по всем переданным участникам. Поэтому приходилось получать данные порционно, да еще и через ограничение RPS, что иногда приводило к запросам более 30 секунд (ограничение Heroku). В результате получалась ошибка из-за таймаута. Чтобы это преодолеть и были введены WEBSOCKETS, т.к. Heroku не разрывает такой тип соединения из-за таймаута.

Если ответ на запрос еще не получен, то веб-сервис раз в 3 секунды шлет сообщение в формате:

```
{
    "status": "processing"
    "message": "INFO-MESSAGE"
}

"INFO-MESSAGE" - строка с пояснением, на каком этапе находится выполнение запроса
```

Это может быть полезно для информирования пользователя, что ничего не зависло, а просто необходимо немного подождать.

WEBSOCKET-запросы доступны для следующих API-методов:

1. [getWebinarReportInfo](#getwebinarreportinfo)
2. [createWebinarReport](#createwebinarreport)
3. [getCampaignsReportInfo](#getcampaignsreportinfo)
4. [createCampaignsReport](#createcampaignsreport)
5. [getCertificatesInfo](#getcertificatesinfo)
6. [createCertificates](#createcertificates)
7. [sendDataToDashaMail](#senddatatodashamail)

[⬆ к оглавлению](#Оглавление)
___

### getWebinarReportInfo

Параметры запроса и ответа аналогичны [GET /getWebinarReportInfo](#get-getwebinarreportinfo).

[⬆⬆ к WEBSOCKET](#websocket-websocket)

[⬆ к оглавлению](#Оглавление)
___

### createWebinarReport

Параметры запроса и ответа аналогичны [POST /createWebinarReport](#post-createwebinarreport).

[⬆⬆ к WEBSOCKET](#websocket-websocket)

[⬆ к оглавлению](#Оглавление)
___

### getCampaignsReportInfo

Параметры запроса и ответа аналогичны [GET /getCampaignsReportInfo](#get-getcampaignsreportinfo).

[⬆⬆ к WEBSOCKET](#websocket-websocket)

[⬆ к оглавлению](#Оглавление)
___

### createCampaignsReport

Параметры запроса и ответа аналогичны [POST /createCampaignsReport](#post-createcampaignsreport).

[⬆⬆ к WEBSOCKET](#websocket-websocket)

[⬆ к оглавлению](#Оглавление)
___

### getCertificatesInfo

Параметры запроса:

| НАЗВАНИЕ |           ТИП            | ОПИСАНИЕ                                                                                                                                    |
|:--------:|:------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------|
|  bookID  |          string          | ID книги в ДМ.                                                                                                                              |

Параметры ответа:

```
{
    "eventName": "", // название мероприятия в bookID
    "eventDate": "", // дата проведения мероприятия в bookID
    "zet": "",       // количество баллов ЗЕТ за мероприятие в bookID 
    "usersInfo": {}, // структура ключ-значение, где ключ - почта пользователя в ДМ, а значение - информация о пользователе для построения отчета
}
```

Ответ содержит указанные параметры, только если они не равны значениям по умолчанию.

Элементы параметра usersInfo имеют следующий вид:

```
{
    "message": "",          // возможная ошибка, которая могла возникнуть во время получения для конкретного email (пустая строка по умолчанию) 
    "fio": "",
    "email": "",
    "key": "",
    "minutesViewedOnline": 0, 
    "firstMinuteOnline": 0, 
    "lastMinuteOnline": 0,
    "minutesOnline": null,  // []int 
    "minutesViewedOffline": 0,
    "firstMinuteOffline": 0,
    "lastMinuteOffline": 0,
    "minutesOffline": null, // []int
    "confirmedWindows": 0,
    "allWindows": 0,
    "wayToAdd": "",
    "eventID": "",
    "citizenship": "",
    "district": "",
    "region": "",
    "city": "",
    "specialization": "",
    "specializationExtra": "",
    "position": "",
    "own": "",
    "viewRegime": "",
    "pointsZOView": 0,
}
```

Элементы параметра usersInfo всегда содержат, как минимум, параметры 'message', 'firstMinuteOnline', 'lastMinuteOnline', 'firstMinuteOffline', 'lastMinuteOffline', 'pointsZOView'. Остальные параметры присутствуют, только если они не равны значениям по умолчанию.

[⬆⬆ к WEBSOCKET](#websocket-websocket)

[⬆ к оглавлению](#Оглавление)
___

### createCertificates

Параметры запроса:

| НАЗВАНИЕ  |           ТИП            | ОПИСАНИЕ                                                                                                                                                       |
|:---------:|:------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| eventName |          string          | Название мероприятия в ДМ.                                                                                                                                     |
| eventDate |          string          | Дата мероприятия в ДМ.                                                                                                                                         |
|    zet    |          string          | Количество баллов ЗЕТ за мероприятие в ДМ.                                                                                                                     |
| usersInfo | map\[string\]interface{} | Структура ключ-значение, где ключ - почта пользователя в ДМ, для которого будет создаваться сертификат, а значение - структура с полями, которые описаны ниже. |

Каждый элемент структуры usersInfo имеет следующие поля:

| НАЗВАНИЕ |           ТИП            | ОПИСАНИЕ                                                                                                                                          |
|:--------:|:------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------|
| message  |          string          | Возможная ошибка, которая могла возникнуть по конкретному пользователю в процессе формирования сертификата для него (пустая строка по умолчанию). |
|   name   |          string          | Имя пользователя в ДМ.                                                                                                                            |
|   nmo    |          string          | Персональный код НМО в ДМ.                                                                                                                        |

Параметры ответа:

```
{
    "links": {},         // структура ключ-значение, где ключ - почта пользователя в ДМ, а значение - ссылка на загруженный на Яндекс.Диск файл
    "unloadedFiles": {}, // структура ключ-значение, где ключ - почта пользователя в ДМ, а значение - структура с описанием незагруженных на Яндекс.Диск файлов
}
```

Элементы параметра links имеют следующий вид:

```
{
    "link": "", // ссылка на загруженный на Яндекс.Диск файл
}
```

Элементы параметра unloadedFiles имеют следующий вид:

```
{
    "fileName": "", // имя файла, в процессе загрузки которого на Яндекс.Диск возникла ошибка
    "error": "",    // текстовое описание ошибки
}
```

[⬆⬆ к WEBSOCKET](#websocket-websocket)

[⬆ к оглавлению](#Оглавление)
___

### sendDataToDashaMail

Параметры запроса и ответа аналогичны [POST /sendDataToDashaMail](#post-senddatatodashamail).

[⬆⬆ к WEBSOCKET](#websocket-websocket)

[⬆ к оглавлению](#Оглавление)
___